<!doctype html><html lang=zh-tw><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Chinchio Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://chinchio.github.io//img/Yanping-Riverside-Park-sunset.jpg"><meta property="twitter:image" content="https://chinchio.github.io//img/Yanping-Riverside-Park-sunset.jpg"><meta name=title content="Google reCAPTCHA v3學習之路 (0)"><meta property="og:title" content="Google reCAPTCHA v3學習之路 (0)"><meta property="twitter:title" content="Google reCAPTCHA v3學習之路 (0)"><meta name=description content="利用Google reCAPTCHA v3及cloudflare worker來進行人機驗證"><meta property="og:description" content="利用Google reCAPTCHA v3及cloudflare worker來進行人機驗證"><meta property="twitter:description" content="利用Google reCAPTCHA v3及cloudflare worker來進行人機驗證"><meta property="twitter:card" content="summary"><meta name=keyword content="Program, Game"><link rel="shortcut icon" href=/img/favicon.ico><title>Google reCAPTCHA v3學習之路 (0) | Chinchio Blog</title><link rel=canonical href=/post/2022-9-12-0-learn-cloudflare-worker-0-google-recaptcha-v3/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link href=https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css rel=stylesheet type=text/css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>Chinchio Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/music>music</a></li><li><a href=/categories/tech>tech</a></li><li><a href=/archive/>ARCHIVE</a></li><li><a href=/notes/>NOTES</a></li><li><a href=/about/>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(https://images.unsplash.com/photo-1563207153-f403bf289096?ixlib=rb-1.2.1&dl=lenin-estrada-OI1ToozsKBw-unsplash.jpg&q=80&fm=jpg&crop=entropy&cs=tinysrgb)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/cloudflare title=cloudflare>cloudflare</a>
<a class=tag href=/tags/recaptcha title=recaptcha>recaptcha</a>
<a class=tag href=/tags/cloudflare-worker title="cloudflare worker">cloudflare worker</a></div><h1>Google reCAPTCHA v3學習之路 (0)</h1><h2 class=subheading>配合cloudflare worker進行人機驗證</h2><span class=meta>Posted by
    "chinchio"
on
Monday, September 12, 2022</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=引言>引言</h1><p>由於本人近日有閱讀一本有關於<code>node.js</code>的書本，而<code>node.js</code>據我所知就是把<code>javascript</code>可以執行在server side上面，而本人之前已經有用<code>goindex</code>拿來把google drive裏面的檔案公開在網路上方便本人存取。</p><h1 id=實作>實作</h1><p>所以既然要碰<code>node.js</code>，那就拿<code>javascript</code>來做點甚麼熟悉一下。</p><p>所以在閱讀<a href=https://developers.cloudflare.com/workers/>Cloudflare Workers documentation</a>後，打算做一下<code>Google reCAPTCHA v3</code>的人機驗證實作。</p><p>之前本人碰到一個將<code>簡體epub轉成繁體epub</code>的網站，裏面就是使用<code>Google reCAPTCHA</code>來進行人機驗證，目的是避免robot盜用該服務導致該server loading 過大，但其實作者沒有在server side作驗證，所以讓我輕鬆地用broser自帶的dev tool來修改程式碼達到繞過驗證的機制。</p><blockquote><p>所以在上述事件的教訓，就是千萬不要相信使用者的input</p></blockquote><p>而參考了下方數個reference後，就寫出下面可以執行在<code>cloudflare worker</code>的程式碼</p><h1 id=code>Code</h1><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>addEventListener(<span style=color:#f1fa8c>&#34;fetch&#34;</span>, event =&gt; {
</span></span><span style=display:flex><span>  event.respondWith(handleRequest(event.request))
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>var</span> index_html <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>`
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&lt;!doctype html&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&lt;head&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &lt;title&gt;cloudflare worker - google recaptcha v3 demo&lt;/title&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&lt;/head&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&lt;body&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &lt;h1&gt;cloudflare worker - google recaptcha v3 demo&lt;/h1&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &lt;form id=&#34;verify_form&#34; method=&#34;post&#34; action=&#34;/verify&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &lt;input type=&#34;hidden&#34; id=&#34;catcha&#34; name=&#34;catcha&#34; /&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    &lt;input type=&#34;submit&#34; value=&#34;verify&#34;&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &lt;/form&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &lt;script src=&#34;https://www.google.com/recaptcha/api.js?render=&lt;YOUR-RECAPTCHA-V3-PUBLIC-KEY&gt;&#34;&gt;&lt;/script&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &lt;script&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    grecaptcha.ready(function() {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      grecaptcha.execute(&#39;&lt;YOUR-RECAPTCHA-V3-PUBLIC-KEY&gt;&#39;, {action: &#39;submit&#39;}).then(function(token) {
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        // Add your logic to submit to your backend server here.
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        document.getElementById(&#34;catcha&#34;).value = token;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        document.getElementById(&#34;pathname&#34;).value = document.location.pathname;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      });
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    });
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  &lt;/script&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>&lt;/body&gt;
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> recaptcha_secret_key <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;&lt;YOUR-RECAPTCHA-V3-SECRET-KEY&gt;&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> gatherResponse(response) {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>/*Copy from [Fetch JSON | Cloudflare Workers docs]*/</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> { headers } <span style=color:#ff79c6>=</span> response;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> contentType <span style=color:#ff79c6>=</span> headers.get(<span style=color:#f1fa8c>&#39;content-type&#39;</span>) <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (contentType.includes(<span style=color:#f1fa8c>&#39;application/json&#39;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> JSON.stringify(<span style=color:#ff79c6>await</span> response.json()); <span style=color:#6272a4>//這才是最重要的部份
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (contentType.includes(<span style=color:#f1fa8c>&#39;application/text&#39;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> response.text();
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> <span style=color:#ff79c6>if</span> (contentType.includes(<span style=color:#f1fa8c>&#39;text/html&#39;</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> response.text();
</span></span><span style=display:flex><span>    } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> response.text();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> handleRequest(request) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> url <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> URL(request.url);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>const</span> {pathname, search} <span style=color:#ff79c6>=</span> url;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>switch</span> (pathname) {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>case</span> <span style=color:#f1fa8c>&#34;/verify&#34;</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>const</span> formData <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> request.formData();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>const</span> body <span style=color:#ff79c6>=</span> {};
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> entry <span style=color:#ff79c6>of</span> formData.entries()) {
</span></span><span style=display:flex><span>            body[entry[<span style=color:#bd93f9>0</span>]] <span style=color:#ff79c6>=</span> entry[<span style=color:#bd93f9>1</span>];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        json_formData <span style=color:#ff79c6>=</span> JSON.stringify(body);
</span></span><span style=display:flex><span>        catcha <span style=color:#ff79c6>=</span> body[<span style=color:#f1fa8c>&#34;catcha&#34;</span>];
</span></span><span style=display:flex><span>        console.log(body[<span style=color:#f1fa8c>&#34;catcha&#34;</span>]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>const</span> isUrlValid <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#39;https://www.google.com/recaptcha/api/siteverify?secret=&#39;</span> <span style=color:#ff79c6>+</span>
</span></span><span style=display:flex><span>        recaptcha_secret_key <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#39;&amp;response=&#39;</span> <span style=color:#ff79c6>+</span> catcha
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>const</span> response <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> fetch(isUrlValid);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>const</span> google_recaptcha_v3_verify_results <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> gatherResponse(response);
</span></span><span style=display:flex><span>        json_verify_results <span style=color:#ff79c6>=</span> JSON.parse(google_recaptcha_v3_verify_results)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        output <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>`\ncatcha: </span><span style=color:#f1fa8c>${</span>catcha<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>\ngoogle_recaptcha_v3_verify_results: </span><span style=color:#f1fa8c>${</span>google_recaptcha_v3_verify_results<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span>(json_verify_results[<span style=color:#f1fa8c>&#34;success&#34;</span>]){
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> Response(<span style=color:#f1fa8c>&#34;You are human!&#34;</span> <span style=color:#ff79c6>+</span> output);
</span></span><span style=display:flex><span>        }<span style=color:#ff79c6>else</span>{
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> Response(<span style=color:#f1fa8c>&#34;You are robot!!!&#34;</span> <span style=color:#ff79c6>+</span> output);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> Response(index_html, {
</span></span><span style=display:flex><span>        headers<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#f1fa8c>&#39;content-type&#39;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;text/html;charset=UTF-8&#39;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=實際demo>實際demo</h1><p>如果各位有使用過註冊一下服務應該會看過Google reCaptcha，之前的驗證方法是給你書本中的圖片，要你去輸入該圖片中的文字，據說是請人類來幫忙把圖書電子化~(即是人肉OCR)~，但reCaptcha v3據說是通過使用者的操作去檢驗該操作是否人類所為。</p><p>Google reCaptcha v3 會在網頁的右下角就會有這樣的提示，相當容易辨認。
<img src=https://i.imgur.com/fm04bm9.png alt="demo index"></p><p>而如果timeout或者reCaptcha v3認為你不是人為操作就會顯示類似如下(下圖是timeout所致)
<img src=https://i.imgur.com/k3rEmeU.png alt="not success with google recaptcha v3 challenge"></p><p>如果檢測是人為操作便會有像下圖的顯示
<img src=https://i.imgur.com/RC5Ii0X.png alt="success with google recaptcha v3 challenge"></p><p>值得注意的是本人寫的程式去檢驗是否人機是由recaptcha v3的verify的<code>success</code>(bool) value來決定，我暫時沒有辦法找到recaptcha v3 document裏面有提及<code>score</code>多少才決定<code>success</code>才為true，當然您也可以透過<code>score</code>來的值來決定是否把該操作視為人為。</p><h1 id=demo-link>Demo Link</h1><p><a href=https://google-recaptcha-v3-demo.cf-learn.workers.dev/>cloudflare worker - google recaptcha v3 demo</a></p><p>#reference:</p><ul><li><a href=https://remotestack.io/how-to-add-google-recaptcha-v3-in-node-js-app/>How to Add Google ReCaptcha v3 in Node Js App</a></li><li><a href=https://developers.google.com/recaptcha/docs/v3>reCAPTCHA v3 | Google Developers</a></li><li><a href=https://developers.cloudflare.com/workers/examples/read-post/>Read POST | Cloudflare Workers docs</a></li><li><a href=https://developers.cloudflare.com/workers/examples/fetch-json/>Fetch JSON | Cloudflare Workers docs</a></li></ul><hr><ul class=pager><li class=previous><a href=/post/2022-8-30-0-install-code-server-on-ubuntu/ data-toggle=tooltip data-placement=top title=利用code-server實現在browser裏面寫code>&larr;
Previous Post</a></li><li class=next><a href=/post/2022-10-11-0-get-pull-rtmp-url/ data-toggle=tooltip data-placement=top title="截取RTMP URL">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/hugo title=hugo>hugo</a>
<a href=/tags/spotify title=spotify>spotify</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a target=_blank href="https://www.facebook.com/profile.php?id=100087271581131"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-facebook fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/chinchio><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Chinchio Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Chinchio Blog 2022<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-JYRLDDQD28"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-JYRLDDQD28",{anonymize_ip:!1})}</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>